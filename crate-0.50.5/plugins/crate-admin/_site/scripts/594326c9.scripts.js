"use strict";!function(){var a=["ngRoute","truncate","sql","stats","common","overview","feed","console","tables","cluster","tableinfo","shardinfo","nodeinfo","udc","nvd3ChartDirectives"],b={"/":{templateUrl:"views/overview.html",controller:"OverviewController"},"/console":{templateUrl:"views/console.html",controller:"ConsoleController"},"/tables":{templateUrl:"views/tables.html",controller:"TableDetailController"},"/tables/:schema_name/:table_name":{templateUrl:"views/tables.html",controller:"TableDetailController"},"/nodes":{templateUrl:"views/node.html",controller:"NodeDetailController"},"/nodes/:node_name":{templateUrl:"views/node.html",controller:"NodeDetailController"}},c=document.getElementsByTagName("head")[0],d=function(a){var b=new XMLHttpRequest;b.open("GET",a,!1),b.send("");var d=document.createElement("script");d.type="application/javascript",d.text=b.responseText,c.appendChild(d)};$.get("conf/plugins.json",function(c){console.info("Loaded Modules:",a),console.info("Loaded Plugins:",c.map(function(a){return a.name}));for(var e=0;e<c.length;e++){var f=c[e];d(f.uri),a.push(f.name)}var g=angular.module("crate",a);g.config(["$routeProvider","$httpProvider",function(a,d){d.defaults.useXDomain=!0;for(var e in b)a.when(e,b[e]);for(var f=0;f<c.length;f++){var g=c[f].routing;if(g)for(var e in g)a.when(e,g[e])}a.otherwise({redirectTo:"/"})}]),g.run(["$window","$location",function(a,b){var c=$.url(a.location.href),d="./"+c.attr("file"),e=c.param("base_uri");e&&(localStorage.setItem("crate.base_uri",e),a.location.href=d+"#/")}]),angular.element(document).ready(function(){angular.bootstrap(document,["crate"])})})}(),angular.module("sql",[]).factory("queryResultToObjects",["_object",function(a){return function(b,c){return $.map(b.rows,function(b,d){return a(c,b)})}}]).factory("_object",function(){return function(a,b){if(a.length!=b.length)return{};for(var c={},d=0;d<a.length;d++)c[a[d]]=b[d];return c}}).factory("SQLQuery",["$http","$location","$log","$q",function(a,b,c,d){function e(a,b,c){this.stmt=a,this.rows=[],this.cols=[],this.rowCount=0,this.duration=0,this.error=c,this.failed=!1,!this.error&&b?(this.rows=b.rows,this.cols=b.cols,this.rowCount=b.rowcount,this.duration=b.duration):this.failed=!0}return e.prototype.status=function(){var a="",b=this.stmt.split(" "),d=b[0].toUpperCase();return d in{CREATE:"",DROP:""}&&(d=d+" "+b[1].toUpperCase()),0==this.failed?(a=d+" OK ("+(this.duration/1e3).toFixed(3)+" sec)",c.info("Query status: "+a)):(a=d+" ERROR ("+(this.duration/1e3).toFixed(3)+" sec)",c.warn("Query status: "+a)),a},e.execute=function(c,f){var g={stmt:c};void 0!=f&&(g.args=f);var h=d.defer(),i=d.defer(),j=i.promise;j.success=function(a){return j.then(function(b){a(b)}),j},j.error=function(a){return j.then(null,function(b){a(b)}),j},j.cancel=function(){h.reject()};var k=b.protocol()+"://"+b.host()+":"+b.port();return null!=localStorage.getItem("crate.base_uri")&&(k=localStorage.getItem("crate.base_uri")),a.post(k+"/_sql",g,{timeout:h.promise}).success(function(a,b,d,f){i.resolve(new e(c,a,null))}).error(function(a,b,d,f){var g=null;b>=400&&a.error?(g=new Error(a.error.message),g.status=a.error.status):b>=400?(g=new Error(a),g.status=b):0===b&&(g=new Error("Connection refused"),g.status=b),i.reject(new e(c,a,g))}),j},e}]),angular.module("health",[]).factory("Health",function(){var a={},b=function c(a){this.set=function(a){this.level=isNaN(a)?c.UNKNOWN:a,this.name=c.NAMES[this.level]||"--"},this.toString=function(){return this.name},this.set(a)};return b.NAMES=["good","warning","critical"],b.NAMES.map(function(b,c){a[b]=c}),b.UNKNOWN=-1,b.GOOD=0,b.WARNING=1,b.CRITICAL=2,b.fromString=function(c){return new b(a[c])},b}),angular.module("stats",["sql","health","tableinfo"]).factory("ClusterState",["$http","$interval","$timeout","$location","$log","SQLQuery","queryResultToObjects","TableList","TableInfo","Health","ShardInfo","$q",function(a,b,c,d,e,f,g,h,i,j,k,l){var m,n,o,p,q={online:!0,tables:[],shards:[],partitions:[],cluster:[],name:"--",status:"--",load:["-.-","-.-","-.-"],loadHistory:[[],[],[]],version:null},r={},s=5e3,t=180,u=function(){var b=d.protocol()+"://"+d.host()+":"+d.port(),c=localStorage.getItem("crate.base_uri");c&&(b=c),a.get(b+"/").success(function(a){if("object"==typeof a){var b=a.version;q.version={number:b.number,hash:b.build_hash,snapshot:b.build_snapshot},v(!0)}else q.version=null,c||e.warn("If you develop and run Crate Admin UI locally you need to set the base_uri. See README.rst for further information."),v(!1)})},v=function(a){q.online&&!a?(q.online=!1,e.warn("Cluster is offline."),b.cancel(m),b.cancel(n),b.cancel(p),q.status="--",q.tables=[],q.cluster=[],q.name="--",q.load=["-.-","-.-","-.-"],q.loadHistory=[[],[],[]],q.version=null,o=b(u,s)):!q.online&&a&&(b.cancel(o),q.online=!0,e.info("Cluster is online."),m=b(A,s),A(),n=b(B,s),B(),p=b(C,s),C())},w=function(a){if(a.length==q.loadHistory.length)for(var b=q.loadHistory,c=0;c<a.length;c++)b[c].push(a[c]),b[c]=b[c].splice(-t,t)},x=function(a){var b=a.error.status;(0===b||404===b)&&v(!1)},y=function(a){for(var b=a.length,c=[0,0,0],d=0;b>d;d++){var e=a[d].load;c[0]+=e[1]/b,c[1]+=e[5]/b,c[2]+=e[15]/b}return w(c),c},z=function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c],e={timestamp:d.timestamp,data:d.fs.total};if(r[d.id]){var f=r[d.id],g=(e.timestamp-f.timestamp)/1e3,h=e.data.reads-f.data.reads,i=e.data.writes-f.data.writes,j=e.data.bytes_read-f.data.bytes_read,k=e.data.bytes_written-f.data.bytes_written;d.iostats={rps:e.data.reads>0?h/g:-1,wps:e.data.writes>0?i/g:-1,rbps:e.data.bytes_read>0?j/g:-1,wbps:e.data.bytes_written>0?k/g:-1}}else d.iostats={rps:-1,wps:-1,rbps:-1,wbps:-1};r[d.id]=e}return a},A=function(){q.online&&h.promise.then(null,null,function(a){if(a.success){var b=a.data.tables.reduce(function(a,b,c){var d=j.fromString(b.health).level;return Math.max(d,a)},0);q.status=new j(b).name,q.tables=a.data.tables}else q.status="--",q.tables=[]})},B=function(){if(q.online){var a=f.execute("select id, name, hostname, rest_url, port, load, heap, fs, os['cpu'] as cpu, load, version, os['probe_timestamp'] as timestamp, process['cpu'] as proc_cpu from sys.nodes");a.success(function(a){var b=g(a,["id","name","hostname","rest_url","port","load","heap","fs","cpu","load","version","timestamp","proc_cpu"]);q.load=y(b),q.cluster=z(b)}).error(x);var b=f.execute("select name from sys.cluster");b.success(function(a){var b=a.rows[0];q.name=b[0]}).error(x)}},C=function(){q.online&&k.executeTableStmt().then(function(a){k.executeShardStmt().then(function(b){k.executePartStmt().then(function(c){q.shards=b,q.tables=a,q.partitions=c;var d={tables:q.tables,shards:q.shards,partitions:q.partitions};k.deferred.resolve(d)})["catch"](function(){var a={tables:q.tables,shards:q.shards};k.deferred.reject(a)})})["catch"](function(){var a={tables:q.tables};k.deferred.reject(a)})})["catch"](function(){k.deferred.reject({})})};return u(),A(),m=b(A,s),C(),p=b(C,s),B(),c(B,500),n=b(B,s),{data:q,HISTORY_LENGTH:t}}]),angular.module("tableinfo",["sql"]).factory("TableInfo",function(){return function(a,b,c){var a=a?angular.copy(a):[],c=c?angular.copy(c):[],d=c.length>0,e=b||0,f=function(){return a.filter(function(a,b){return a.primary})}(),g=function(){return a.reduce(function(a,b,c){return a+b.count},0)}(),h=function(){return a.filter(function(a,b){return"STARTED"==a.state})}(),i=function(){return h.reduce(function(a,b,c){return a+b.count},0)}(),j=function(){return a.filter(function(a,b){return["STARTED","RELOCATING"].indexOf(a.state)>-1&&a.primary===!0}).reduce(function(a,b,c){return a+b.count},0)}(),k=function(){return f.reduce(function(a,b,c){return a+b.size},0)}(),l=function(){return f.reduce(function(a,b,c){return a+b.sum_docs},0)}(),m=function(){return d&&0===i?0:e-j}(),n=function(){return a.filter(function(a,b){return!(["STARTED","RELOCATING"].indexOf(a.state)>-1)&&a.primary===!1}).reduce(function(a,b,c){return a+b.count},0)}(),o=function(){return a.filter(function(a,b){return"UNASSIGNED"==a.state}).reduce(function(a,b,c){return a+b.count},0)}(),p=function(){var a=f.reduce(function(a,b,c,d){return a+b.avg_docs/d.length},0);return Math.ceil(a*n)}(),q=function(){var a=h.reduce(function(a,b,c,d){return a+b.avg_docs/d.length},0);return Math.ceil(a*m)}(),r=function(){return d&&0===i?"good":0===g?"critical":m>0?"critical":o>0||n>0?"warning":"good"}();this.asObject=function(){return{shards_configured:e,health:r,shards_started:i,shards_missing:m,shards_underreplicated:n,records_total:l,records_unavailable:q,records_underreplicated:p,size:k,partitioned:d,partitioned_by:c}}}}).factory("TableList",["$timeout","$q","TableInfo","SQLQuery","roundWithUnitFilter","bytesFilter","ShardInfo",function(a,b,c,d,e,f,g){var h=b.defer(),i={tables:[]},j=null,k=5e3,l={good:2,warning:1,critical:0,"--":0},m={good:"label-success",warning:"label-warning",critical:"label-danger","--":""},n={good:"panel-success",warning:"panel-warning",critical:"panel-danger","--":"panel-default"},o=function(a,b){return l[a.health]<l[b.health]?-1:l[a.health]>l[b.health]?1:a.name<b.name?-1:a.name>b.name?1:0},p=function(b,d,f,g){var l=d||[],p=f||[],r=g||[];if(b&&l.length){for(var s=0;s<l.length;s++){var t=l[s],u=p.filter(function(a,b){return a.table_name===t.name&&a.schema_name==t.schema_name}),v=r.filter(function(a,b){return a.table_name===t.name&&a.schema_name==t.schema_name});t.partitioned_by&&1===v.length&&(t.shards_configured=v[0].num_shards);var w=new c(u,t.shards_configured,t.partitioned_by),x=w.asObject();$.extend(t,x),t.health_label_class=m[t.health],t.health_panel_class=n[t.health],t.type_display_name="blob"==t.schema_name?"Blob":"Record";var y=t.shards_configured+" Shards";y+=" / "+t.replicas_configured+" Replicas",t.records_unavailable?y=e(t.records_unavailable,1)+" Unavailable Records / "+y:t.shards_underreplicated&&(y=t.shards_underreplicated+" Underreplicated Shards / "+y),t.records_underreplicated&&(y=t.records_underreplicated+" Underreplicated Records / "+y),t.summary=y}i.tables=l.sort(o)}else i.tables=[];h.notify({success:b,data:i}),j=a(q,k)},q=function r(){a.cancel(j),g.deferred.promise.then(function(a){p(!0,a.tables,a.shards,a.partitions)})["catch"](function(a){jQuery.isEmptyObject(a)||(a.tables&&a.shards?p(!0,a.tables,a.shards):a.tables?p(!0,a.tables):p(!1))})["finally"](function(){g.deferred.promise=b.defer().promise,r()})};return q(),{data:i,promise:h.promise}}]),angular.module("shardinfo",[]).factory("ShardInfo",["SQLQuery","queryResultToObjects","$q",function(a,b,c){var d={deferred:c.defer()},e="select table_name, number_of_shards, number_of_replicas, schema_name, partitioned_by from information_schema.tables where schema_name not in ('information_schema', 'sys')",f='select table_name, schema_name, _node[\'id\'] as node_id, state, count(*), "primary", sum(num_docs), avg(num_docs), sum(size) from sys.shards group by table_name, schema_name, node_id, state, "primary"',g="select table_name, schema_name, sum(number_of_shards) as num_shards from information_schema.table_partitions group by table_name, schema_name";return d.executeTableStmt=function(){var d=c.defer(),f=d.promise;return a.execute(e).success(function(a){var c=b(a,["name","shards_configured","replicas_configured","schema_name","partitioned_by"]);d.resolve(c)}).error(function(){d.reject()}),f},d.executeShardStmt=function(){var d=c.defer(),e=d.promise;return a.execute(f).success(function(a){var c=b(a,["table_name","schema_name","node_id","state","count","primary","sum_docs","avg_docs","size"]);d.resolve(c)}).error(function(){d.reject()}),e},d.executePartStmt=function(){var d=c.defer(),e=d.promise;return a.execute(g).success(function(a){var c=b(a,["table_name","schema_name","num_shards"]);d.resolve(c)}).error(function(){d.reject()}),e},d}]),angular.module("nodeinfo",[]).factory("NodeHealth",function(){var a=function b(a){var c=function(a){return a>b.THRESHOLD_CRITICAL?2:a>b.THRESHOLD_WARNING?1:0},d=Math.max(a.fs.used_percent,a.heap.used_percent),e=c(d);this.value=e,this.status=["good","warning","critical"][e]};return a.THRESHOLD_CRITICAL=98,a.THRESHOLD_WARNING=90,a}).provider("NodeListInfo",function(){var a={sort:{col:["health_value","name"],desc:!1},sortBy:function(a){0===this.sort.col.indexOf(a)?this.sort.desc=!this.sort.desc:(this.sort.col=this.sort.col.reverse(),this.sort.desc=!1)},sortClass:function(a){return 0===this.sort.col.indexOf(a)?this.sort.desc?"fa fa-chevron-down":"fa fa-chevron-up":""}};this.$get=function(){return a}}).factory("prepareNodeList",["NodeHealth",function(a){var b={good:"label-success",warning:"label-warning",critical:"label-danger","--":""};return function(c){for(var d=[],e=0;e<c.length;e++){var f=angular.copy(c[e]);f.health=new a(f),f.health_value=f.health.value,f.health_label_class=b[f.health.status],f.health_panel_class=b[f.health.status],f.heap.used_percent=100*f.heap.used/f.heap.max,f.heap.free_percent=100-f.heap.used_percent,d.push(f)}return d}}]).factory("compareByHealth",function(){return function(a,b){return a.health.value<b.health.value?-1:a.health.value>b.health.value?1:a.name<b.name?-1:a.name>b.name?1:0}}),angular.module("udc",[]).factory("UdcSettings",function(){var a="crate.user_email";return{SegmentIoToken:"vd4x4hv637",Email:{get:function(){return localStorage.getItem(a)||null},set:function(b){return b?(localStorage.setItem(a,b),!0):!1},unset:function(){localStorage.removeItem(a)}}}}).factory("Uid",function(){var a=function(a){this.uid=a};return a.create=function(b){return new a(b)},a.NAME="uid",a.prototype.isValid=function(){return this.uid?null!==this.uid.match(/^[a-f0-9]{32}$/):!1},a.prototype.toString=function(){return this.uid},a}).factory("UidLoader",["$q","Uid",function(a,b){var c=function(a){var b=document.createElement("iframe");return b.id="ifr"+(new Date).getTime(),b.style.width="0px",b.style.height="0px",b.src=a,document.getElementsByTagName("body")[0].appendChild(b),b};return{load:function(){var d="cdn.crate.io",e="/libs/crate/uid.html",f=a.defer(),g=f.promise;g.success=function(a){return g.then(a,null,null),g},g.error=function(a){return g.then(null,a,null),g},g.notify=function(a){return g.then(null,null,a),g},window.addEventListener("message",function(a){if(a.origin.match(d)){f.notify(a);var c=b.create(a.data[b.NAME]);c.isValid()?f.resolve(c):f.reject(new Error("Cookie failed to load"))}},!1);var h="https:"===window.location.protocol?"https:":"http:";return c(h+"//"+d+e),g}}}]);var commons=angular.module("common",["stats","udc"]).controller("StatusBarController",["$scope","$log","$location","$sce","ClusterState",function(a,b,c,d,e){var f={good:"label-success",warning:"label-warning",critical:"label-danger","--":"label-danger"},g="https://crate.io/docs",h=function(a){return d.trustAsResourceUrl(g+(a?"/en/"+a.number:"/stable")+"/")};a.cluster_color_label="label-default",a.$watch(function(){return e.data},function(b){var c=[],d=b.cluster.filter(function(a,b){var d=!1;if(a.version){var e=a.version.build_hash;d=-1==c.indexOf(e),c.push(e)}return d}).map(function(a,b){return a.version.number});a.versions=d,a.version_warning=d.length>1,a.cluster_state=b.status,a.cluster_name=b.name,a.num_nodes=b.cluster.length,a.cluster_color_label=f[b.status],a.load1="-.-"==b.load[0]?b.load[0]:b.load[0].toFixed(2),a.load5="-.-"==b.load[1]?b.load[1]:b.load[1].toFixed(2),a.load15="-.-"==b.load[2]?b.load[2]:b.load[2].toFixed(2),a.version=b.version,a.docs_url=h(b.version)},!0),$("[rel=tooltip]").tooltip({placement:"bottom"})}]).controller("NavigationController",["$scope","$location","NavigationService",function(a,b,c){a.navBarElements=c.navBarElements,a.isActive=function(a){return"/"==a?a===b.path():b.path().substr(0,a.length)==a}}]).service("NavigationService",function(){this.navBarElements=[],this.addNavBarElement=function(a,b,c,d){"/"!=c.charAt(0)&&(c="/"+c);var e={text:b,iconClass:a,urlPattern:c};"undefined"==typeof d?this.navBarElements.push(e):0>d||d>=this.navBarElements.length?this.navBarElements.push(e):this.navBarElements.splice(d,0,e)}}).directive("fixBottom",function(){return function(a,b,c){var d=$(b),e=$(".side-nav .navbar-nav"),f=$(window),g=function(){a.fixBottom=e.offset().top+e.height()+d.height()<f.height()};f.on("resize",g),g()}}).controller("HelpMenuController",["$scope","UidLoader","UdcSettings",function(a,b,c){var d=null;analytics.load(c.SegmentIoToken),analytics.ready(function(){var a=analytics.user();d={id:a.id(),traits:a.traits()}});var e=function(a){var b=a.email&&a.uid&&a.enabled;b&&(analytics.identify(a.uid,{email:a.email},{userAgent:navigator.userAgent,integrations:{All:!1,Intercom:{}}}),analytics.page())};a.user={email:c.Email.get(),uid:null,enabled:null!==c.Email.get()},a.enable=function(b){c.Email.set(b.email),a.user.enabled=!0,e(a.user)},a.disable=function(){c.Email.unset(),a.user.enabled=!1,a.user.email=null,analytics.reset(),$("#intercom-container").remove()},b.load().success(function(b){a.user.uid=b.toString(),e(a.user)}).error(function(a){console.warn(a)}).notify(function(a){})}]);commons.run(["NavigationService",function(a){a.addNavBarElement("fa fa-th-large","Overview","/"),a.addNavBarElement("fa fa-code","Console","/console"),a.addNavBarElement("fa fa-table","Tables","/tables"),a.addNavBarElement("fa fa-sitemap","Cluster","/nodes")}]),angular.module("feed",["stats"]).factory("FeedService",["$http",function(a){var b="/feed/json?callback=JSON_CALLBACK";return{parse:function(c){return a.jsonp(c+b,{cache:!1})}}}]).factory("NotificationService",["$http",function(a){var b=null,c="crate.readNotifications";return{readItems:function(){if(null===b){var a=localStorage.getItem(c);b=a?JSON.parse(a):[]}return b},markAsRead:function(a){var d=this.readItems();d.push(a),b=d,localStorage.setItem(c,JSON.stringify(d))}}}]).controller("NotificationsController",["$scope","$sce","$http","$filter","FeedService","NotificationService","ClusterState",function(a,b,c,d,e,f,g){var h,i="https://crate.io/blog/category/developernews",j=5,k="https://crate.io/versions.json";a.showUpdate=!1,a.numUnread=0,a.entries=[],a.blog_url=i;var l=function(b){if("all"===b){for(var c=a.entries,d=0;d<c.length;d++)f.markAsRead(c[d].id);a.numUnread=0}else b&&(f.markAsRead(b.id),a.numUnread=Math.max(0,a.numUnread-1))},m=function(a){for(var b=f.readItems(),c=a.id,d=0;d<b.length;d++)if(b[d]===c)return!0;return!1};c.get(k,{withCredentials:!0}).success(function(a){a&&a.crate&&(h=a.crate)}),e.parse(i,j).then(function(c){var e=d("characters");if(200===c.status&&c.data.length>0){var f=c.data.splice(0,j),g=f.length;f.map(function(a,c){a.title=b.trustAsHtml(a.title),a.preview=b.trustAsHtml(e(a.excerpt,150)),a.timestamp=new Date(a.date),a.id=a.timestamp.getTime().toString(32),m(a)&&g--}),a.entries=f,a.numUnread=g}}),a.$watch(function(){return g.data},function(b){a.showUpdate=b.version&&h&&h>b.version.number,a.stableVersion=h,a.serverVersion=b.version?b.version.number:"",a.noNotifications=!a.showUpdate&&0===a.entries.length},!0),a.noNotifications=!0,a.isRead=m,a.markAsRead=l}]),angular.module("overview",["stats"]).factory("ZeroArray",function(){return function(a){for(var b=new Array(a),c=0;c<b.length;c++)b[c]=0;return b}}).factory("HistoryChart",function(){return function(a){var b=[{key:"Load 1",values:[],color:"#55d4f5",area:!0},{key:"Load 5",values:[],color:"#5987ff"},{key:"Load 15",values:[],color:"#115097"}];this.size=a,this.data=function(){return b},this.update=function(a){for(var c=[[],[],[]],d=0;d<this.size;d++)c[0][d]=[d,a[0][d]],c[1][d]=[d,a[1][d]],c[2][d]=[d,a[2][d]];for(var d=0;d<c.length;d++)b[d].values=c[d];return this}}}).controller("OverviewController",["$scope","$location","$log","$timeout","ClusterState","HistoryChart","ZeroArray",function(a,b,c,d,e,f,g){var h=null,i={good:"panel-success",warning:"panel-warning",critical:"panel-danger","--":"panel-default"};a.available_data="--",a.records_unavailable="--",a.replicated_data="--",a.records_total="--",a.records_underreplicated="--",a.cluster_state="--",a.cluster_color_class="panel-default",a.chart={data:[]},a.$watch(function(){return e.data},function(b){var c=(new Date).getTime();if(!(h&&100>c-h)){if(h=c,a.cluster={name:b.name,state:b.status},a.cluster_color_class=i[b.status],b.loadHistory[0].length>0&&k(b.loadHistory),!b.tables||!b.tables.length)return a.available_data=100,a.records_unavailable=0,a.replicated_data=100,a.records_total=0,void(a.records_underreplicated=0);var d=b.tables;a.records_underreplicated=d.reduce(function(a,b,c){return b.records_underreplicated+a},0),a.records_unavailable=d.reduce(function(a,b,c){return b.records_unavailable+a},0),a.records_total=d.reduce(function(a,b,c){return b.records_total+a},0),a.records_total>0?(a.replicated_data=Math.max(0,a.records_total-a.records_underreplicated)/a.records_total*100,a.available_data=Math.max(0,a.records_total-a.records_unavailable)/a.records_total*100):(a.replicated_data=100,a.available_data=100)}},!0);var j=new f(e.HISTORY_LENGTH),k=function(b){for(var c=b[0].length,d=[g(e.HISTORY_LENGTH-c),g(e.HISTORY_LENGTH-c),g(e.HISTORY_LENGTH-c)],f=0;f<d.length;f++)d[f].push.apply(d[f],b[f]);a.chart.data=j.update(d).data()};$("[rel=tooltip]").tooltip({placement:"top"})}]),angular.module("console",["sql"]).directive("console",["SQLQuery","$timeout",function(a,b){return{restrict:"A",controller:["$scope",function(b){var c=null,d=[],e="";b.error={hide:!0,message:""},b.info={hide:!0,message:""},this.setInputScope=function(a){c=a};var f=Ladda.create(document.querySelector("button[type=submit]"));b.storeInLocalStorageChanged=function(){localStorage.setItem("crate.console.store_queries",j===!0?"1":"0")};var g=function(){var a=localStorage.getItem("crate.console.query_list");d=a?JSON.parse(a):[]},h=function(a){j&&g(),d[d.length-1]!==a&&d.push(a+";"),j&&localStorage.setItem("crate.console.query_list",JSON.stringify(d)),c.recentCursor=-1};b.hide=function(a){a.hide=!0,a.message=""},b.toggleOptions=function(){$("#console-options").slideToggle(),b.info.hide=!0,b.info.message=""},b.clearLocalStorage=function(){var a=JSON.parse(localStorage.getItem("crate.console.query_list")||"[]");localStorage.setItem("crate.console.query_list",JSON.stringify([])),c.recentCursor=0,d=[];var e=1==a.length?"1 entry in console history has been cleared.":a.length+" entries in console history have been cleared.";b.info.message=e,b.info.hide=!1};var i=localStorage.getItem("crate.console.store_queries")||"1",j=!!parseInt(i);g();var k=function(d){var e=d.replace(/^\s+|\s+$/g,"");""!==e&&(e=e.replace(/([^;]);+$/,"$1"),e.match(/^\s*select\s/gi)&&!e.match(/limit\s+\d+/gi)&&(e+=" limit 100"),h(e),f.start(),a.execute(e).success(function(a){f.stop(),b.error.hide=!0,b.error.message="",b.info.hide=!0,b.info.message="",b.renderTable=!0,b.resultHeaders=[];for(var d in a.cols)b.resultHeaders.push(a.cols[d]);b.rows=a.rows,b.status=a.status(),b.statement=e+";",c.updateInput(b.statement)}).error(function(a){f.stop(),b.error.hide=!1,b.renderTable=!1,b.error.message=a.error.message,b.status=a.status(),b.rows=[],b.resultHeaders=[]}))};this.recentQueries=d,this.execute=k,this.updateStatement=function(a){e=a},b.execute=function(){k(e)}}]}}]).directive("cli",["$timeout",function(a){return{restrict:"E",transclude:!0,templateUrl:"views/editor.html",scope:{mimeType:"=",theme:"="},require:"^console",link:function(b,c,d,e){e.setInputScope(b),b.recentCursor=0,b.updateInput=function(a){i(a)};var f="",g="",h=$("textarea",c)[0],i=function(b){b&&j.setValue(b),a(function(){j.execCommand("selectAll")},10)},j=CodeMirror.fromTextArea(h,{mode:d.mimeType,theme:d.theme});j.on("change",function(a,b){f=a.getValue(),e.updateStatement(f)}),j.on("keydown",function(a,c){var d=c.target.selectionStart,h=e.recentQueries.length,j=f.indexOf(";"),k=a.getCursor(),l=a.getSelection();c.shiftKey||38!==c.keyCode?c.shiftKey||40!==c.keyCode?13===c.keyCode&&c.shiftKey?-1!=j&&(c.preventDefault(),e.execute(f),g=""):b.recentCursor=0:(d>=c.target.textLength||0===d&&c.target.selectionEnd===f.length)&&h+b.recentCursor<h&&(b.recentCursor++,f=e.recentQueries[h+b.recentCursor]||g,i(f)):(0===k.ch&&0===k.line||0===k.line&&l===f)&&(0===b.recentCursor&&(g=f),b.recentCursor--,f=e.recentQueries[h+b.recentCursor],i(f))})}}}]).controller("ConsoleController",["$scope","$http","$location","SQLQuery","$log","$timeout",function(a,b,c,d,e,f){}]),angular.module("tables",["stats","sql","common","tableinfo"]).provider("TabNavigationInfo",function(){this.collapsed=[!1,!0],this.$get=function(){var a=this.collapsed;return{collapsed:a,toggleIndex:function(b){a[b]=!a[b]}}}}).factory("PartitionsTableController",function(){return function(){this.data=[],this.sort={col:"partition_ident",desc:!1},this.setPartitions=function(a){this.data=a},this.sortByColumn=function(a){this.sort.col===a?this.sort.desc=!this.sort.desc:(this.sort.col=a,this.sort.desc=!1)},this.selected=function(a){return a===this.sort.col?this.sort.desc?"fa fa-chevron-down":"fa fa-chevron-up":""}}}).controller("TableDetailController",["$scope","$location","$log","$timeout","$route","SQLQuery","queryResultToObjects","roundWithUnitFilter","bytesFilter","TableList","TableInfo","TabNavigationInfo","PartitionsTableController",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n={},o=5e3,p=null,q={good:"",warning:"label-warning",critical:"label-danger","--":""},r={name:"Tables (0 found)",summary:"",health:"--",health_label_class:"",health_panel_class:"",records_total:0,records_replicated:0,records_underreplicated:0,records_unavailable:0,shards_configured:0,shards_started:0,shards_active:0,shards_missing:0,shards_underreplicated:0,replicas_configured:"0",size:0},s=e.current;a.$on("$locationChangeSuccess",function(a){if(u(),"TableDetailController"===e.current.$$route.controller){var b=e.current.params;v(b.schema_name,b.table_name),e.current=s,e.current.params=b}}),$("[rel=tooltip]").tooltip({placement:"top"}),a.toggleSidebar=function(){$("#page-viewport").toggleClass("show-sidebar"),$(".menu-toggle i.fa").toggleClass("fa-angle-double-right").toggleClass("fa-angle-double-left")};var t=function(){return"r-"+(new Date).getTime()+"-"+Math.floor(1e3*Math.random())},u=function(){d.cancel(p);for(var a in n){var b=n[a];b.cancel()}n={}},v=function(b,c){a.ptCtlr=new m,a.nothingSelected=!1,a.renderSiderbar=!0,a.isParted=!1,a.$watch(function(){return j.data},function(d){var f=d.tables;if(f.length>0){var g=f.filter(function(a,d){return a.name===c&&a.schema_name===b});g=g.length?g[0]:f[0],a.table=g,a.table_label=g.name,"blob"==g.schema_name?a.table_label="BLOB: "+g.name:"doc"!=g.schema_name&&(a.table_label=g.schema_name+"."+g.name),a.nothingSelected=null===g,a.renderSidebar=!0,a.table.partitioned&&e()}else a.table=r,a.table_label=r.name,a.nothingSelected=!1,a.renderSidebar=!1,a.renderSchema=!1,a.renderPartitions=!1},!0);var e=function(){if(u(),c&&b){var a='select partition_ident, sum(num_docs), "primary", avg(num_docs), count(*), state, sum(size) from sys.shards where schema_name = ? and table_name = ? and partition_ident != \'\' group by partition_ident, "primary", state',d=t(),e=f.execute(a,[b,c]).success(function(a){if("undefined"!=typeof n[d]){var e="select partition_ident, number_of_shards, number_of_replicas, values from information_schema.table_partitions where schema_name = ? and table_name = ?",i=t(),j=f.execute(e,[b,c]).success(function(b){if("undefined"!=typeof n[i]){for(var c=[],d=g(a,["partition_ident","sum_docs","primary","avg_docs","count","state","size"]),e=g(b,["partition_ident","number_of_shards","number_of_replicas","values"]),f=d.reduce(function(a,b,c){var d=b.partition_ident;return-1===a.indexOf(d)&&a.push(d),a},[]),j=0;j<f.length;j++){var l=f[j],m=d.filter(function(a,b){return a.partition_ident===l}),o=e.filter(function(a,b){return a.partition_ident===l});if(1===o.length){var p=new k(m,o[0].number_of_shards),r=p.asObject();r.partition_values=o[0].values,r.partition_ident=l,r.replicas_configured=o[0].number_of_replicas,r.health_label_class=q[r.health],c.push(r)}}delete n[t],h(!0,c)}}).error(function(a){delete n[t],h(!1,[])});n[i]=j}}).error(function(a){delete n[t],h(!1,[])});n[d]=e}},h=function(b,c){a.ptCtlr.data=c,a.isParted=!0,a.renderPartitions=b,a.renderSchema=b,p=d(e,o)};if(c&&b){var i="select column_name, data_type from information_schema.columns where schema_name = ? and table_name = ?";f.execute(i,[b,c]).success(function(b){a.schemaHeaders=b.cols,a.schemaRows=b.rows,a.renderSchema=!0}).error(function(b){a.renderSchema=!1})}a.$on("$destroy",function(){d.cancel(p)}),a.table=null,a.renderSidebar=!0,a.renderSchema=!1,a.renderPartitions=!1};v(e.current.params.schema_name,e.current.params.table_name)}]).controller("TableListController",["$scope","$route","TableList","TabNavigationInfo",function(a,b,c,d){a.$on("$locationChangeSuccess",function(a){if("TableDetailController"===b.current.$$route.controller){var c=b.current.params;e(c.schema_name,c.table_name)}});var e=function(b,e){a.renderSidebar=!0,a.$watch(function(){return c.data},function(c){var d=c.tables,f=d.length>0;if(a.renderSidebar=f,f){e&&b||(e=d[0].name,b=d[0].schema_name);var g=[];for(var h in d){var i=d[h].schema_name;"doc"==i||"blob"==i||g.indexOf(i)>-1||g.push(i)}a.tables=[{display_name:"Doc Tables",tables:d.filter(function(a,b){return"doc"==a.schema_name}),schema_name:"doc"}];for(var h in g){var i=g[h];a.tables.push({display_name:i+" Tables",tables:d.filter(function(a,b){return a.schema_name==i}),schema_name:i})}a.tables.push({display_name:"Blob Tables",tables:d.filter(function(a,b){return"blob"==a.schema_name}),schema_name:"blob"})}else a.tables=[]},!0),a.isActive=function(a,c){return c===e&&a===b},a.startedShardsError=function(a){return a.partitioned&&0===a.shards_started?!1:a.shards_started<a.shards_configured},a.toggleElements=function(a){$("#nav-tabs-"+a).collapse("toggle"),$("#nav-tabs-header-"+a+" i.fa").toggleClass("fa-caret-down").toggleClass("fa-caret-right"),d.toggleIndex(a)},a.isCollapsed=function(a){return d.collapsed[a]}};e(b.current.params.schema_name,b.current.params.table_name)}]),angular.module("cluster",["stats","sql","common","nodeinfo"]).controller("NodeListController",["$scope","$route","ClusterState","prepareNodeList","NodeHealth","NodeListInfo","compareByHealth",function(a,b,c,d,e,f,g){a.nodes=[],a.selected=null,a.percentageLimitYellow=e.THRESHOLD_WARNING,a.percentageLimitRed=e.THRESHOLD_CRITICAL;var h=null,i=null,j=null;a.$on("$locationChangeSuccess",function(a){"NodeDetailController"===b.current.$$route.controller&&k(b.current.params.node_name)});var k=function(b){j=b,h&&h(),h=a.$watch(function(){return c.data},function(b){var c=angular.copy(b.cluster);i=b.version;var e=c.length>0;a.renderSidebar=e;var f=d(c);if(e){f=f.sort(g);var h=f.map(function(a){return a.name});if(j&&h.indexOf(j)>=0){var k=f.filter(function(a,b){return a.name===j});a.selected=k.length?k[0]:f[0]}else a.selected=f[0],j=f[0].name}else a.selected=null;a.nodes=f},!0)};a.sort=f.sort,a.sortBy=f.sortBy,a.sortClass=f.sortClass,a.isActive=function(a){return a.name===j},a.isSameVersion=function(a){return i?a.build_hash===i.hash:!0},k(b.current.params.node_name)}]).controller("NodeDetailController",["$scope","$interval","$route","$http","$filter","ClusterState","prepareNodeList","NodeHealth","compareByHealth",function(a,b,c,d,e,f,g,h,i){var j=e("bytes");a.node=null,a.percentageLimitYellow=h.THRESHOLD_WARNING,a.percentageLimitRed=h.THRESHOLD_CRITICAL;var k={name:"Cluster is not reachable",id:"",summary:[],health:"--",health_label_class:"",health_panel_class:"",hostname:"--",address:"",version:{number:"--",build_hash:"",build_snapshot:!1},heap:{total:0,free:0,used:0,used_percent:0,free_percent:0},fs:{total:0,available:0,used:0,available_percent:0,used_percent:0},shardInfo:{started:-1,initializing:-1,reallocating:-1,postrecovery:-1}},l={used:"#55d4f5",free:"#e2e2e2"},m=null,n=null,o=c.current;a.$on("$locationChangeSuccess",function(a){if("NodeDetailController"===c.current.$$route.controller){var b=c.current.params;r(b.node_name),c.current=o,c.current.params=b}});var p=function(a){var b={total:0,available:0,used:0,available_percent:0,used_percent:0};if(a.fs.data){for(var c=[],d=0;d<a.fs.data.length;d++)c.push(a.fs.data[d].dev);
for(var e=0;e<a.fs.disks.length;e++){var f=a.fs.disks[e],g=c.indexOf(f.dev)>-1;g&&(b.total+=f.size,b.available+=f.available,b.used+=f.used)}b.available_percent=100*b.available/b.total,b.used_percent=100*b.used/b.total}return b},q=function(a,b){return a.filter(function(a){return a.state===b}).reduce(function(a,b){return a+b.count},0)},r=function(b){n&&n(),n=a.$watch(function(){return f.data},function(c){for(var d=angular.copy(c.cluster),e=angular.copy(c.shards),f=0;f<d.length;f++)d[f].fs=p(d[f]);m=c.version;var h=d.length>0;a.renderSidebar=h;var j=g(d);if(h){j=j.sort(i);var l=j.map(function(a){return a.name});if(b&&l.indexOf(b)>=0){var n=j.filter(function(a,c){return a.name==b});a.node=n.length?n[0]:j[0]}else a.node=j[0];s(a.node)}else a.node=angular.copy(k);if(e&&e.length){var o=e.filter(function(b){return b.node_id===a.node.id});a.shardInfo={started:q(o,"STARTED"),initializing:q(o,"INITIALIZING"),reallocating:q(o,"REALLOCATING"),postrecovery:q(o,"POST_RECOVERY")}}},!0)};a.toolTipUsedPercentFunction=function(){return function(a,b,c,d,e){return"<p>"+a+"<br /><b>"+c+"%</b></p>"}},a.toolTipUsedBytesFunction=function(){return function(a,b,c,d,e){return"<p>"+a+"<br /><b>"+c+"</b></p>"}},a.yAxisByteFormatFunction=function(){return function(a){return j(a,2)}};var s=function(b){a.cpuData=[{key:"System",values:[["CPU",b.cpu.system]],color:l.used},{key:"User",values:[["CPU",b.cpu.user]],color:"#5987ff"},{key:"Idle",values:[["CPU",Math.max(0,100-b.cpu.system-b.cpu.user-b.cpu.stolen)]],color:l.free},{key:"Stolen",values:[["CPU",b.cpu.stolen]],color:"#ff814d"}],a.heapData=[{key:"Used",values:[["HEAP",b.heap.used]],color:l.used},{key:"Free",values:[["HEAP",b.heap.max-b.heap.used]],color:l.free}],a.diskUsageData=[{key:"Used",values:[["Disk Usage",b.fs.used]],color:l.used},{key:"Free",values:[["Disk Usage",b.fs.available]],color:l.free}]};$("[rel=tooltip]").tooltip({placement:"top"}),a.toggleSidebar=function(){$("#page-viewport").toggleClass("show-sidebar"),$(".menu-toggle i.fa").toggleClass("fa-angle-double-right").toggleClass("fa-angle-double-left")},a.isSameVersion=function(a){return m?a.build_hash===m.hash:!0},r(c.current.params.node_name)}]),angular.module("common").filter("capitalize",function(){return function(a,b){return a.substring(0,1).toUpperCase()+a.substring(1)}}),angular.module("common").filter("floor",["$filter",function(a){return function(b,c){var d=Math.pow(10,c);return a("number")(Math.floor(b*d)/d,c)}}]).filter("roundWithUnit",["$filter","$sce",function(a,b){return function(c,d){void 0==d&&(d=3);var e="";return e=Math.abs(Number(c))>=1e9?a("number")(Math.abs(Number(c))/1e9,d)+" Billion":Math.abs(Number(c))>=1e6?a("number")(Math.abs(Number(c))/1e6,d)+" Million":a("number")(Math.abs(Number(c)),0),b.trustAsHtml(e)}}]).filter("bytes",["$sce",function(a){return function(b,c){if(isNaN(parseFloat(b))||!isFinite(b))return"-";if(0===b)return"0 B";"undefined"==typeof c&&(c=1);var d=["B","KB","MB","GB","TB","PB"],e=Math.floor(Math.log(b)/Math.log(1024)),f=(b/Math.pow(1024,Math.floor(e))).toFixed(c)+" "+d[e];return a.trustAsHtml(f)}}]);