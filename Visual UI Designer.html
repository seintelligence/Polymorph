<!DOCTYPE html>
<html>
    
<link rel="stylesheet" href="bower_components/open-sans-fontface/open-sans.css">
<script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
<script src="scripts/jquery.min.js"></script>

<link rel="import" href="bower_components/polymer/polymer.html">

<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/editor-icons.html">

<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/paper-styles/paper-styles.html">
<link rel="import" href="bower_components/paper-progress/paper-progress.html">
  
<link rel="import" href="bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
    
<link rel="import" href="elements/UtilitiesBehavior.html">

<link rel="import" href="elements/ui editor elements/layout-elt.html">
<link rel="import" href="elements/ui editor elements/d3js-tree-cpt.html">
<link rel="import" href="elements/ui editor elements/text-cpt.html">
<link rel="import" href="elements/ui editor elements/h1-cpt.html">
<!--<link rel="import" href="elements/ui editor elements/table-cpt.html">-->

<link rel="import" href="elements/ui editor elements/DragBehavior.html">
<link rel="import" href="elements/ui editor elements/ToasterRxBehavior.html">

<!-- Connection toolbar -->
<link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
	  <link rel="import" href="elements/cockpit elements/Cockpit-connect.html">

<link rel="import" href="elements/ui editor elements/path_json_editor-cpt.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<!-- JSON tree -->
<link href="scripts/JSON-tree/css/jsontree.css" rel="stylesheet">
<script src="scripts/JSON-tree/src/jsontree.js"></script>

<div is="visual-ui-editor-library-cpt" style="display:inline-block; width:100%"></div>

<dom-module id="visual-ui-editor-library-cpt">
	<style>
		.header_panel {
			font-family: "Open Sans";
			color: white;
			padding: 5px;
		};
		#UIElementsCatalog div {
			margin:4px;
			width:75px;
			cursor: move;
			text-align:center;
			padding:2px;
			list-style-type:none;
		}
		
		.UIcatalogIcons {
			 --paper-fab-background: var(--paper-light-blue-500);
			--paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
		}
		
		paper-progress {
		  display: block;
		  width: 100%;
		   --paper-progress-active-color: var(--paper-light-blue-500);
		}
		
      paper-toggle-button.blue {
        --paper-toggle-button-checked-bar-color:  var(--paper-light-blue-500);
        --paper-toggle-button-checked-button-color:  var(--paper-light-blue-500);
        --paper-toggle-button-checked-ink-color: var(--paper-light-blue-500);
        --paper-toggle-button-unchecked-bar-color:  var(--paper-light-blue-900);
        --paper-toggle-button-unchecked-button-color:  var(--paper-light-blue-900);
        --paper-toggle-button-unchecked-ink-color: var(--paper-light-blue-900);
      }
	  
	  toggleHelperBold { font-weight: 500;}
	  
		.container {
			background-color:rgb(240, 240, 240);
			min-height: 40px;
			border-radius: 4px;
			display: block;
			padding: 5px;
		};
		
		.acceptingContainer {
			border-radius: 5px;
			box-shadow: inset 0 0 10px #95FF68;
		}
		
		.refusingContainer {
			border-radius: 5px;
			box-shadow: inset 0 0 10px #FF6868;
		}
		
		.dragged {
			opacity: 0.5;
		}
	</style>
	<template>
	
		<!-- get the Json Structure -->
		<getJsonStructure-cpt json_schema="{{json_schema}}"></getJsonStructure-cpt>
		
		<!-- Dialog box for JSON path filtering configuration in development mode -->
		<paper-dialog id="modal" modal="" role="dialog" tabindex="-1" aria-modal="true" class="x-scope paper-dialog-0" style="outline: none; box-sizing: border-box; position: static; display: none;" aria-hidden="true">
			<h2>Filtering</h2>
			<paper-dialog-scrollable>
				<path_json_editor-cpt
					filter="[[current_filter]]"
					computed_nested_filter="{{computed_nested_filter}}"
				></path_json_editor-cpt>
			</paper-dialog-scrollable>
			<div class="buttons">
				<paper-button dialog-dismiss>Cancel</paper-button>
				<paper-button dialog-confirm on-click="validateFiltering">Accept</paper-button>
			</div>
		</paper-dialog>
		<div class="fullbleed layout vertical">
			<!-- The application main toolbar -->
			<paper-toolbar>
			  <paper-icon-button icon="menu" on-tap="menuAction"></paper-icon-button>
				<div class="title">Polymorph by SEI</div>
				<Cockpit-connect is-connected="{{isConnected}}"></Cockpit-connect>
			  <paper-icon-button icon="more-vert" on-tap="moreAction"></paper-icon-button>
			</paper-toolbar>
			<!-- Progress bar -->
			<div class="layout flex horizontal"><paper-progress value="90"></paper-progress></div>
		
			<div class="layout horizontal flex">
				<!-- The catalog of UI elements to DnD -->
				<div class="paper-header has-shadow header_panel" hidden$='[[!isMode("Development", mode)]]'>
					<div class="content layout vertical flex" id="UIElementsCatalog">
						
						<paper-menu>
							<paper-item id="stuctureMenuItem">Structural Elements</paper-item>
							<paper-item id="catalogStructure">
								<div is="layout-elt" mode="Icon" draggable="true" on-dragstart="UIdragStart" on-dragenter="UIdragEnter" on-dragend="UIdragEnd" id="layout-elt"></div>
							</paper-item>
							<paper-item id="textMenuItem">Text Elements</paper-item>
							<paper-item id="catalogText">
								<div is="text-cpt" mode="Icon" draggable="true" on-dragstart="UIdragStart" on-dragenter="UIdragEnter" on-dragend="UIdragEnd" id="text-cpt"></div>
								<div is="h1-cpt" mode="Icon" draggable="true" on-dragstart="UIdragStart" on-dragenter="UIdragEnter" on-dragend="UIdragEnd" id="h1-cpt"></div>
							</paper-item>
							<paper-item id="datavizMenuItem" onSelect="oo">Data Visualisation Elements</paper-item>
							<paper-item id="catalogDataViz">
								<div is="d3js-tree-cpt" mode="Icon" draggable="true" on-dragstart="UIdragStart" on-dragenter="UIdragEnter" on-dragend="UIdragEnd" id="d3js-tree-cpt"></div>
							</paper-item>		
						</paper-menu>
                        
                        
						
									
					</div>
				</div>
				
				<div class="layout vertical flex" style="padding: 20px;">
					<!-- View Configuration toolbar -->
					<div class="content layout horizontal">
						
						<!-- rights -->
						<iron-icon title="Give rights for this view: Who can access this view and with which rights?" on-click='' icon="icons:supervisor-account"></iron-icon>
						
						<!-- classification -->
						<iron-icon title="Classify this view to better find it back: Which tag attach to this view and in which folders to classify it?" on-click='' icon="icons:folder"></iron-icon>
						
						<!-- save the UI -->
						<div class="layout flex">
							<iron-icon title="Save this view" on-click='saveView' icon="icons:save">saved</iron-icon>
						</div>
							
						<!-- In Development ==> Operational icon -->					
						<div class="layout end-justified">
							<div class="line">
								<span id="modeToggleOperational">Operational</span>
								<paper-toggle-button checked="true" id="modeToggle" class="blue" on-change="modeTogglechange" title="Switch the visual mode: Development or Operational mode"></paper-toggle-button>
								<span id="modeToggleEdition">Edition</span>
							</div>
						</div>
					</div>
					
					<!-- The container receiving the drag drop -->
					<div id="UItopContainer" class="flex" is="layout-elt" mode="Development" structure="[[structure]]"></div>
					<span id="JSONstructure"></span>
                    <span id="JSONhtml"></span>
				</div>
			</div>
		</div>
		
		<!-- paper toasts - messages bubbling in the bottom of the window -->
		<!-- information -->
		<paper-toast id="toasterInformation" text="[[toasterMessage]]" class="" aria-hidden="true"></paper-toast>
		<!-- warning -->
		<paper-toast id="toasterWarning" text="[[toasterMessage]]" class="" aria-hidden="true">
			<span role="button" tabindex="0" style="color: #eeff41;margin: 10px" onclick="console.log('CANCEL')">Cancel</span>
		</paper-toast>
		<!-- error -->
		<paper-toast id="toasterError" text="[[toasterMessage]]" class="" aria-hidden="true">
			<span id="label" class="style-scope paper-toast">Connection timed out. Showing limited messages.</span>
		</paper-toast>
		
	</template>
	<script>
		Polymer({
			is: 'visual-ui-editor-library-cpt',
			
			behaviors: [DragBehavior, ToasterTxBehavior, ToasterRxBehavior],

			extends: 'div',

			properties: {
				mode:
				{
					type: String,
					value: "Development",
					notify: true
				},
				
				uniqueID:
				{
					value: 0
				},
				
				current_filter:
				{
					type: String,
					value: "*"
				},
				
				computed_nested_filter:
				{
					type: String,
					value: "*",
					notify: true
				},
				
				structure: {
					type: Object,
					value: {
                        id: '',
                        is: '',
                        config: {
                            computed_nested_filter: '',
                            divUniqueId: 0,
                            layoutHorizVert: false,
                            layoutFlex: false,
                            layoutIterate: false,
                            provides: ''
                        },
                        children: {}
                    },
                    observer: 'observeJSONstructure'
                    
				}
			},
            
            observer: ['observeJSONstructure(structure.*)'],
			
			listeners: {
				'pathJsonEditorRequest': 'callPathJsonEditorModal',
				//'childrenUpdate': 'observeJSONstructure'
			},
            
            attached: function() {
                var host = this;
                this.$.UItopContainer.addEventListener("structure-changed", function(e){
                    console.log("/host structure changed");
                    host.observeJSONstructure();
                });
                
            },
			
			sendModeChangedRequest: function(mode) {
				this.mode = mode; 
				this.sendToasterMsgDisplayRequest("UI mode switched to " + mode, "information");
				this.$.UItopContainer.fire('UImodeChangedRequest', { "mode": this.mode });
			},
			
			saveView: function() { this.sendToasterMsgDisplayRequest("UI view saved", "information");}, 
			
			callPathJsonEditorModal: function(ev) {
				var msg = ev.detail;
				this.computed_nested_filter = msg.computed_nested_filter;
				this.current_filter = msg.current_filter;
				this.callerPathJsonEditor = ev.srcElement;
				this.$.modal.open();
			},
			
			isSelectedCatalog: function(catalog) {
				console.log( this.querySelector( "#" + catalog ) );
			},
			
			isMode: function(mode) { return this.mode == mode; },
			
			modeTogglechange: function() {
				if ( this.isMode('Development') )
					this.sendModeChangedRequest('Operational');
				else 
					this.sendModeChangedRequest('Development');
			},
			
			validateFiltering: function(ev) {
				var caller = Polymer.dom(this.callerPathJsonEditor);
				caller.setAttribute("computed_nested_filter", this.computed_nested_filter);
				caller.setAttribute("current_filter", this.current_filter);
			},
			
			observeJSONstructure: function(ev) {
                console.log('observeJSONstructure');
                var structure = this.structure;
                console.log(structure);
                //if ( structure.id == "UItopContainer" ) {
                    document.getElementById("JSONstructure").innerHTML = JSONTree.create(structure);
                    var HTMLstructure = this.createHTMLstructure2( structure );
                    document.getElementById("JSONhtml").innerHTML = HTMLstructure;
                //}
                
			},
            
            createHTMLstructure: function(structure) {
                console.log("createHTMLstructure");
                
                var cpt = document.createElement('div');
                
                // id
                cpt.setAttribute('id', structure.id);
                
                // is
                cpt.setAttribute('is', structure.is);
                
                // config
                var config = structure.config;
                for (var key in config) {
                   if (config.hasOwnProperty(key)) {
                        var obj = config[key];
                       // If this is a boolean
                        if ( typeof obj === 'boolean' )
                        {
                            if ( obj ) cpt.setAttribute(key);
                            else cpt.removeAttribute(key);
                        }
                        // else
                        else
                            cpt.setAttribute(key, obj);
                    }
                }
                
                // children
                var children = structure.children;
                console.log(children);
                for (var child in children) {
                    console.log("child found");
                    console.log(children[child]);
                    var childCpt = this.createHTMLstructure(children[child]);
                    cpt.appendChild(childCpt);
                }
                
                console.log(cpt);
                // return the computed html structure
                return cpt;
            },
            
            createHTMLstructure2: function(structure) {
                console.log("createHTMLstructure");
                
                var cpt = '<div ';
                
                // id
                cpt = cpt + 'id="' + structure.id + '" ';
                
                // is
                cpt = cpt + 'is="' + structure.is + '" ';
                
                // config
                var config = structure.config;
                for (var key in config) {
                   if (config.hasOwnProperty(key)) {
                        var obj = config[key];
                       // If this is a boolean
                        if ( typeof obj === 'boolean' )
                        {
                            if ( obj ) cpt = cpt + key + ' ';
                        }
                        // else
                        else
                            cpt = cpt + key + '="' + obj + '" ';
                    }
                }
                
                cpt = cpt + '>';
                
                // children
                var children = structure.children;
                for (var child in children) {
                    console.log("child found");
                    console.log(children[child]);
                    var childCpt = this.createHTMLstructure2(children[child]);
                    cpt + childCpt;
                }
                
                cpt = cpt + '</div>';
                console.log(cpt);
                // return the computed html structure
                return cpt;
            }
		});
	</script>
</dom-module>
</html>