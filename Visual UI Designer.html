<link rel="stylesheet" href="bower_components/open-sans-fontface/open-sans.css">
<script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
<script src="scripts/jquery.min.js"></script>

<link rel="import" href="bower_components/polymer/polymer.html">

<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/editor-icons.html">

<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">

<link rel="import" href="elements/ui editor elements/layout-elt.html">
<link rel="import" href="elements/d3js-tree-elt.html">

<link rel="import" href="elements/ui editor elements/DragBehavior.html">
<link rel="import" href="elements/ui editor elements/ToasterRxBehavior.html">

<link rel="import" href="elements/ui editor elements/path_json_editor-cpt.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<div is="visual-ui-editor-library-cpt" style="display:inline-block; width:100%" ></div>

<dom-module id="visual-ui-editor-library-cpt">
	<style>
		.header_panel {
				font-family: "Open Sans";
				background-color: #4285f4;
				color: white;
				padding: 5px;
		};
		#UIElementsCatalog div {
			margin:4px;
			width:75px;
			cursor: move;
			text-align:center;
			padding:2px;
			box-shadow: 1px 1px 12px #555;
			list-style-type:none;
		};
		.container {
			background-color:rgb(240, 240, 240);
			min-height: 40px;
			border-radius: 4px;
			display: block;
			padding: 5px;
		};
		
		.acceptingContainer {
			border-radius: 5px;
			box-shadow: inset 0 0 10px #95FF68;
		}
		
		.refusingContainer {
			border-radius: 5px;
			box-shadow: inset 0 0 10px #FF6868;
		}
		
		.dragged {
			opacity: 0.5;
		}
	</style>
	<template>
	
		<!-- get the Json Structure -->
		<getJsonStructure-cpt json_schema="{{json_schema}}"></getJsonStructure-cpt>
		
		<!-- Dialog box for JSON path filtering configuration in development mode -->
		<paper-dialog id="modal" modal="" role="dialog" tabindex="-1" aria-modal="true" class="x-scope paper-dialog-0" style="outline: none; box-sizing: border-box; position: static; display: none;" aria-hidden="true">
			<h2>Filtering</h2>
			<paper-dialog-scrollable>
				<path_json_editor-cpt
					filter="[[current_filter]]"
					computed_nested_filter="{{computed_nested_filter}}"
				></path_json_editor-cpt>
			</paper-dialog-scrollable>
			<div class="buttons">
				<paper-button dialog-dismiss>Cancel</paper-button>
				<paper-button dialog-confirm on-click="validateFiltering">Accept</paper-button>
			</div>
		</paper-dialog>
	
		<!-- The catalog of UI elements to DnD -->
		<div style="display:inline-block; width:100%">
			<div class="paper-header has-shadow header_panel" >
				<div class="content layout horizontal" id="UIElementsCatalog">
					<div is="layout-elt" mode="Icon" draggable="true" on-dragstart="UIdragStart" on-dragenter="UIdragEnter" on-dragend="UIdragEnd" id="layout-elt"></div>
					<div is="d3js-tree-elt" mode="Icon" draggable="true" on-dragstart="UIdragStart" on-dragenter="UIdragEnter" on-dragend="UIdragEnd" id="d3js-tree-elt"></div>
				</div>
			</div>
		</div>
		
		<div class="content layout horizontal">
			<!-- In Development ==> Operational icon -->
			<div hidden$='[[!isMode("Operational", mode)]]'>
				<iron-icon title="Switch the visual mode: from Operational to Development mode" on-click="switchToDevelopmentMode" icon="editor:mode-edit"></iron-icon>
			</div>
			
			<!-- In Operational ==> Development icon -->
			<div hidden$='[[!isMode("Development", mode)]]'>
				<iron-icon title="Switch the visual mode: from Development to Operational mode" on-click='switchToOperationalMode' icon="icons:visibility"></iron-icon>
			</div>
			
			<!-- rights -->
			<iron-icon title="Give rights for this view: Who can access this view and with which rights?" on-click='' icon="icons:supervisor-account"></iron-icon>
			
			<!-- classification -->
			<iron-icon title="Classify this view to better find it back: Which tag attach to this view and in which folders to classify it?" on-click='' icon="icons:folder"></iron-icon>
			
			<!-- save the UI -->
			<iron-icon title="Save this view" on-click='saveView' icon="icons:save">saved</iron-icon>
		</div>
		
		<!-- The container receiving the drag drop -->
		<div id="UItopContainer" is="layout-elt" mode="Development"></div>
		
		<!-- paper toasts - messages bubbling in the bottom of the window -->
		<!-- information -->
		<paper-toast id="toasterInformation" text="[[toasterMessage]]" class="" aria-hidden="true"></paper-toast>
		<!-- warning -->
		<paper-toast id="toasterWarning" text="[[toasterMessage]]" class="" aria-hidden="true">
			<span role="button" tabindex="0" style="color: #eeff41;margin: 10px" onclick="console.log('CANCEL')">Cancel</span>
		</paper-toast>
		<!-- error -->
		<paper-toast id="toasterError" text="[[toasterMessage]]" class="" aria-hidden="true">
			<span id="label" class="style-scope paper-toast">Connection timed out. Showing limited messages.</span>
		</paper-toast>
		
	</template>
	<script>
		Polymer({
			is: 'visual-ui-editor-library-cpt',
			
			behaviors: [DragBehavior, ToasterRxBehavior],

			extends: 'div',

			properties: {
				mode:
				{
					type: String,
					value: "Development",
					notify: true
				},
				
				uniqueID:
				{
					value: 0
				},
				
				toasterMessage:
				{
					type: String,
					value: ""
				
				},
				
				current_filter:
				{
					type: String,
					value: "*"
				},
				
				computed_nested_filter:
				{
					type: String,
					value: "*",
					notify: true
				}
			},
			
			listeners: {
				'toasterMessageRequest': 'displayToasterMessage',
				'pathJsonEditorRequest': 'callPathJsonEditorModal'
			},
			
			sendModeChangedRequest: function(mode) {
				this.mode = mode; 
				this.sendToasterMsgDisplayRequest("UI mode switched to " + mode, "information");
				this.$.UItopContainer.fire('UImodeChangedRequest', { "mode": this.mode });
			},
			
			isMode: function(mode) { return this.mode == mode; },
			
			switchToOperationalMode: function(mode) { this.sendModeChangedRequest("Operational");},
			
			switchToDevelopmentMode: function(mode) { this.sendModeChangedRequest("Development");},
			
			saveView: function() { this.sendToasterMsgDisplayRequest("UI view saved", "information");}, 
			
			callPathJsonEditorModal: function(ev) {
				this.computed_nested_filter = ev.detail.computed_nested_filter;
				this.current_filter = ev.detail.current_filter;
				this.callerPathJsonEditor = ev.srcElement;
				this.$.modal.open();
			},
			
			validateFiltering: function(ev) {
				var caller = Polymer.dom(this.callerPathJsonEditor);
				caller.setAttribute("computed_nested_filter", this.computed_nested_filter);
				caller.setAttribute("current_filter", this.current_filter);
			}
			
		});
	</script>
</dom-module>