<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<!--<link rel="import" href="select_Filter_DataSource-cpt.html">-->
<link rel="import" href="select_Link_DataSource-cpt.html">

<link rel="import" href="../UtilitiesBehavior.html">

<dom-module id="select_Item_DataSource-cpt">
     <style>
		:host {
		  @apply(--layout-horizontal);
		};
		
		.Filter_panel {
			@apply(--layout-vertical);
		};
		
		.JSON_Filter_Buttons {
			font-family: "Open Sans";
			background: #4285f4;
			color: white;
		};
	</style>
    
    <template>
        <!-- The selection of the items -->
        <template is="dom-repeat" items="[[ echoArray(computed_nested_item_datasource) ]]" as="item" observe="*">
            
            <div class="layout vertical center">
                <div style="margin-bottom:6px;">
                    <paper-button title="[[item.name]]" raised class="JSON_Filter_Buttons" on-click="setSelected_item">
                        <template is="dom-if" if="[[!item.isSelected]]">
                            <iron-icon icon="cancel"></iron-icon>
                        </template>
                        <span>[[item.name]]</span>
                    </paper-button>
                </div>

                <!-- Filters and links -->
                <!--<template is="dom-if" if="[[item.isSelected]]">-->

                    <!-- The selection of the filters -->
                    <select_Filter_DataSource-cpt structure_schema="[[structure_schema]]" current_item="[[item]]" computed_nested_filter_datasource="{{item.filters}}"></select_Filter_DataSource-cpt>

                    <!-- The selection of the links -->
                    <select_Link_DataSource-cpt structure_schema="[[structure_schema]]" current_item="[[item]]" computed_nested_link_datasource="{{items.links}}"></select_Link_DataSource-cpt>
                
                <!--</template>-->
            </div>
        </template>
    </template>
    
    <script>
		 Polymer({
			is: 'select_Item_DataSource-cpt',
			
			behaviors: [UtilitiesBehavior],

			properties: {
				current_link:
                {
                    type: Object,
					value: function() { return [];},
					observer: "_observe_structure_schema"
                },
                structure_schema:
				{
					type: Object,
                    value: function() { return {};},
					observer: "_observe_structure_schema"
				},
				computed_nested_item_datasource:
				{
					type: Array,
                    notify: true,
                    value: function() { return [];}
				},
                current_items:
                {
                    type: Array
                }
			},
             
             ready: function(){
                 console.log("/ready select item");
                 console.log(this.current_link);
                 console.log(this.structure_schema);
                 
                 this._observe_structure_schema();
                 
             },
             
             _observe_structure_schema: function()
             {
                console.log("/_observe_structure_schema.................;;;");
                var structure_schema = this.structure_schema;
                 var current_link = this.current_link;
                 
                if (structure_schema === undefined)
                    return 0;

                if (typeof structure_schema === 'string') 
                    var structure_schema = JSON.parse(structure_schema);

                if ( !structure_schema.hasOwnProperty('linkage_structure_schema') )
                    return 0;
                 
                 if (typeof current_link === 'string') 
                    var current_link = JSON.parse(current_link);
                
                 console.log(current_link);
                 
                var items = structure_schema.linkage_structure_schema[current_link.name].to;
                 
                 this.computed_nested_item_datasource = [];
                 
                 for (var key in items) {
                     var name = key;
                     var item = {
                        'isSelected': false,
                        'name': name,
                        'filters': {},
                        'links': {}
                     };
                     
                     this.push('computed_nested_item_datasource', item);
                     console.log(this.computed_nested_item_datasource);
                 };
                 
             },
             
             _observe_nested_datasource: function() {
                console.log("/_observe_nested_datasource.................;;;");
                 
             },
             
             setSelected_item: function(e)
			{				
				var model = e.model;
				
				// get current selection status
				var isCurrentlySelected = this.get('computed_nested_item_datasource.' + model.__key__ + '.isSelected');
				
                console.log(isCurrentlySelected);
				// set all the filters to not selected
				//this.updateComputed_nested_item_datasource();
				
				// invert current selection status
				this.set('computed_nested_item_datasource.' + model.__key__ + '.isSelected', !isCurrentlySelected);
				
				// get updated current selection status
				var isCurrentlySelected = this.get('computed_nested_item_datasource.' + model.__key__ + '.isSelected');
				console.log(isCurrentlySelected);
                
                console.log(this.computed_nested_item_datasource);
                
				// reset sub_filter
				//if (isCurrentlySelected)
				//	this.resetSub_filter();
					
				// updateCurrent_filter
				var currentlySelected_item = "";
				
				if (isCurrentlySelected) currentlySelected_item = this.get('computed_nested_item_datasource.' + model.__key__ + '.name')
				//this.updateCurrent_filter(currentlySelected_item);
				
				// update the current json based on the filter
				//this.updateCurrent_json();
			},
             
             isNotSelected: function(isSelected) { console.log(isSelected); return !isSelected && this.current_filter != "";},
             
         });
    </script>
</dom-module>