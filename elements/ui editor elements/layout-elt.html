<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="layout-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="DropBehavior.html">
<link rel="import" href="ModeChangedBehavior.html">
<link rel="import" href="ToasterTxBehavior.html">
<link rel="import" href="../UtilitiesBehavior.html">

<dom-module id='layout-elt'>
	<style>
		
		.development::hover {
			border-radius: 5px;
			box-shadow: inset 0 0 10px #95FF68;
		}
			
		.acceptingContainer {
			border-radius: 5px;
			box-shadow: inset 0 0 10px #95FF68;
			margin: 5px;
			padding: 5px;
		}
		
		.development {
			font-family: RobotoDraft, Helvetica, Arial, sans-serif;
			font-kerning: auto;
			font-size: 16px;
			font-stretch: normal;
			font-style: normal;
			font-variant: normal;
			font-variant-ligatures: normal;
			font-weight: 300;
			background-color:white;
			font-family: "Open Sans";
			margin: 1px;
			padding: 5px;
			height: auto;
			border-radius: 4px;
			border: 1px dotted rgb(150, 150, 150);
		};
		
		.development .icons {
			border: none;
			cursor: pointer;
		}
		
		.development .container {		
			background-color:rgb(250, 250, 250);
		}
		
		.operational {
			font-family: RobotoDraft, Helvetica, Arial, sans-serif;
			font-kerning: auto;
			font-size: 16px;
			font-stretch: normal;
			font-style: normal;
			font-variant: normal;
			font-variant-ligatures: normal;
			font-weight: 300;
			background-color:rgb(250, 250, 250);
			font-family: "Open Sans";
			margin: 1px;
			padding: 5px;
			min-height: 200px;
			border-radius: 4px;
			border-width: 1px
		}
	</style> 
	<template>
		
		<!-- Development -->
		<div class="layout auto-vertical flex development" hidden$='[[!isMode("Development", mode)]]'>
			
			<div class="layout flex horizontal">
				<!-- Filters control -->
				<div class="development icons">
					<iron-icon title="filter the parent source of data provided by this component to sub-ccomponent" icon="filter-list" data-dialog="modal" on-click="sendPathJsonEditorRequest"></iron-icon>
				</div>
				<!-- Filters computation -->
				<div class="">
					<span>filter:</span>
					<span>{{computed_nested_filter}}</span>
				</div>
				<div class="">
					&nbsp;
				</div>
				<!-- Provides computation -->
				<div class="flex">
					<span>Provides:</span>
					<span>{{provides}}</span>
				</div>
				<!-- Flex control -->
				<div class="layout horizontal development icons">
					<iron-icon title="Switch to a flexible layout (take the remaining horizontal space) or not" id="iconLayoutFlex" icon="icons:fullscreen-exit" on-click="switchLayoutFlex"></iron-icon>
				</div>
				<!-- horizontal / vertical layout control -->
				<div class="layout horizontal development icons">
					<iron-icon title="Switch layout horizontal<=>vertical" id="iconLayoutHorizVert" icon="icons:swap-horiz" on-click="switchLayoutHorizVert"></iron-icon>
				</div>
				<!-- iterate layout control -->
				<div class="layout horizontal development icons">
					<iron-icon title="Switch to iterate the content over the found object or not (-)" id="iconLayoutIterate" icon="icons:autorenew" on-click="switchIterating"></iron-icon>
				</div>
				<!-- delete control -->
				<div class="layout end-justified development icons">
					<iron-icon title="Delete this component" id="iconLayoutDelete" icon="icons:delete" on-click="sendRemoveUIChildRequest"></iron-icon>
				</div>
			</div>
			
			<div id="blockContainer" class="layout vertical flex development container">
				<div class="layout horizontal">
					<div>
						<!-- check if no element is currently dragged -->
						<template is="dom-if" if="[[_currentDragIsCompatible(0)]]">
							<iron-icon icon="input"></iron-icon>
						</template>
						
						<!-- check if currently dragged element is compatible -->
						<template is="dom-if" if="[[_currentDragIsCompatible(1)]]">
							<iron-icon icon="check-circle"></iron-icon>
						</template>
						
						<!-- check if currently dragged element is not compatible -->
						<template is="dom-if" if="[[_currentDragIsCompatible(2)]]">
							<iron-icon icon="block"></iron-icon>
						</template>
					</div>
				</div>
				<!-- where objects are dropped -->
				<div id="container" class="layout horizontal"></div>
			</div>
		</div>
		
		<!-- Operational -->
		<div hidden$='[[!isMode("Operational", mode)]]'>
			<div class="layout horizontal flex operational"></div>
		</div>
		
		<!-- Icon -->
		<div hidden$='[[!isMode("Icon", mode)]]'>
			<div draggable="false" is="layout-icon"></div>
		</div>
	</template>

	<script>
		Polymer({
			is: 'layout-elt',
			
			behaviors: [DropBehavior, ModeChangedBehavior, ToasterTxBehavior, UtilitiesBehavior],
			
			extends: 'div',
			
			properties: {
				/* UI structure */
				// UI children
				structure:
				{
					type: Object,
					notify: true,
					value:{
						"id": "",
						"config": {
							"computed_nested_filter": "",
							"divUniqueId": 0,
							"layoutHorizVert": false,
							"layoutFlex": false,
							"layoutIterate": false
						},
						"children": {}
					},
					readonly: true,
					observer: 'updateJsonUIstructure'
				},
				
				// Unique children Id reference
				divUniqueId: 
				{
					type: Number,
					value: 1
				},
				
				/* UI configuration */
				// id
				id:
				{
					type: String,
					value: 'no ID',
					observer: 'updateJsonUIstructure'
				},
				
				// accepts data type
				accepts:
				{
					type: String,
					value: "*",
					notify: true
				},
				
				// provides data type
				provides:
				{
					type: String,
					value: "",
					notify: true
				},
				
				// current filter on the jsondata of the computed parents nodes
				current_filter:
				{
					type: String,
					value: "*",
					observer: '_resetFiltering'
				},
				
				// computed filter of this node (following configuration) : "current_filter" for the children of this node
				computed_nested_filter:
				{
					type: String,
					value: "*",
					notify: true,
					observer: "_getProvides"
				},
								
				// 0: horiz, 1: vert
				layoutHorizVert:
				{
					type: Boolean,
					value: 0
				},
				
				// 1: flex
				layoutFlex:
				{
					type: Boolean,
					value:false
				},
				
				// 1: iterate
				layoutIterate:
				{
					type: Boolean,
					value:false
				}				
				
			},
			
			listeners: {
				'UIchildrenUpdate': '_receiveChildrenUpdate'
			},
			
			observers: ['updateJsonUIstructure(id, computed_nested_filter, divUniqueId, layoutFlex, layoutHorizVert, layoutIterate, structure)'],
			
			ready: function() { this.structure.id = this.id; },
			
			/* Structure management : this element and its config (layout + filter) + children */
			//		
			updateJsonUIstructure: function() {
				console.log("updateJsonUIstructure");
				console.log(this.structure);
				/*var structure = {
					"id": this.id,
					"config": {
						"computed_nested_filter": this.computed_nested_filter,
						"divUniqueId": this.divUniqueId,
						"layoutHorizVert": this.layoutHorizVert,
						"layoutFlex": this.layoutFlex,
						"layoutIterate": this.layoutIterate
					},
					"children": this.childrenStructure
				};*/
				this.fire('UIchildrenUpdate', { "id": this.id, "request": "update", "structure": this.structure  });
			},
			
			_receiveChildrenUpdate: function(ev) {
				console.log("_receiveChildrenUpdate");
				console.log(ev);
				var data = ev.detail,
					id = data.id,
					request = data.request;
					
				console.log(id);
				console.log(this.id);
					
				if (id.split(this.id)[1]) {
					console.log("received from children");
					if( request == "update" )
						this.structure.children[id] = data.structure;
					if( request == "remove" )
						this.structure.children[id].remove();
						
					console.log(data.structure);
				}
				console.log(this.structure);
			},
			
			/* Layout config */
			switchLayoutHorizVert: function(ev) {
				this.layoutHorizVert = !this.layoutHorizVert;
				
				var sOld = (this.layoutHorizVert?"horizontal":"vertical"),
					sNew = (this.layoutHorizVert?"vertical":"horizontal");
					
				this.sendToasterMsgDisplayRequest("Layout changed from " + sOld + " to " + sNew, "information");
				
				$(this.$.container).removeClass(sOld);
				$(this.$.container).addClass(sNew);
				this.$.iconLayoutHorizVert.icon = "icons:swap-" + (this.layoutHorizVert?"vert":"horiz");
				
				// update the structure to propagate the update to the parents
				this.structure.config.layoutHorizVert = this.layoutHorizVert;
				
			},
			
			switchLayoutFlex: function(ev) {
				this.layoutFlex = !this.layoutFlex;
				this.toggleClass("flex", this.layoutFlex);
				
				this.sendToasterMsgDisplayRequest("Layout changed to " + (this.layoutFlex?"flex":"not flex", "information"));
					
				if (this.layoutFlex) {
					$(this).addClass("flex");
					this.$.iconLayoutFlex.icon = "icons:fullscreen";
				} else {
					$(this).removeClass("flex");
					this.$.iconLayoutFlex.icon = "icons:fullscreen-exit";
				}
				
				// update the structure to propagate the update to the parents
				this.structure.config.layoutFlex = this.layoutFlex;
			},
			
			switchIterating: function(ev) {
				this.layoutIterate = !this.layoutIterate;
				
				this.sendToasterMsgDisplayRequest("Layout changed to " + (this.layoutIterate?"iterate":"not iterate"), "information");
				this.$.iconLayoutIterate.icon = (this.layoutIterate?"icons:remove":"icons:autorenew");
				
				// update the structure to propagate the update to the parents
				this.structure.config.layoutIterate = this.layoutIterate;
			},
			
			/* sert a rien pour l'instant Non Op */
			_currentDragIsCompatible: function(type) {
				if (type == 0)	return 1;
				else return 0;
			},
			
			/* Filtering */
			sendPathJsonEditorRequest: function(ev) {
				this.fire('pathJsonEditorRequest', { "current_filter": this.current_filter, "computed_nested_filter": this.computed_nested_filter});
			},
			
			_getProvides: function() {
				var sFilter = this.computed_nested_filter.split("/");
				this.provides = sFilter[sFilter.length-1];
				
				// update the structure to propagate the update to the parents
				this.structure.config.provides = this.provides;
			},
			
			_resetFiltering: function(ev) {
				console.log("_resetFiltering");
				this.computed_nested_filter = "";
				
				// update the structure to propagate the update to the parents
				this.structure.config.provides = this.computed_nested_filter;
			}
		});
	</script>
</dom-module>