<!DOCTYPE html>
<html>
    

    <head>
        <title>Fancytree - Example: Glyph Extension / Bootstrap Theme</title>

        <link rel="import" href="../bower_components/polymer/polymer.html">
        <link rel="import" href="../connect-app/data-source-elt-cpt.html">
        <link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
        <link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
        <link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

        <meta http-equiv="content-type" content="text/html; charset=utf-8">

        <script src="../scripts/xmlToJSON.js" type="text/javascript" ></script>
        <script src="../scripts/underscore-min.js" type="text/javascript"></script>
        <script src="../scripts/jquery.min.js" type="text/javascript"></script>
        <script src="../scripts/jquery-ui.min.js" type="text/javascript"></script>
        
        
		<script src="modernizr.custom.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/draggabilly/1.2.0/draggabilly.pkgd.min.js"></script>
		<script src="dragdrop.js"></script>

        <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>

        <link href="../bower_components\jquery.fancytree/dist/skin-bootstrap/ui.fancytree.min.css" rel="stylesheet" type="text/css" class="skinswitcher">


        <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" >

      <script src="../bower_components/jquery.fancytree/dist/jquery.fancytree.min.js" type="text/javascript"></script>
      <script src="../bower_components/jquery.fancytree/dist/src/jquery.fancytree.dnd.js" type="text/javascript"></script>
      <script src="../bower_components/jquery.fancytree/dist/src/jquery.fancytree.edit.js" type="text/javascript"></script>
      <script src="../bower_components/jquery.fancytree/dist/src/jquery.fancytree.glyph.js" type="text/javascript"></script>
      <script src="../bower_components/jquery.fancytree/dist/src/jquery.fancytree.table.js" type="text/javascript"></script>
      <script src="../bower_components/jquery.fancytree/dist/src/jquery.fancytree.wide.js" type="text/javascript"></script>
    </head>
    
    
        <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.indigo-pink.min.css">
        <script src="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

<oo-cpt></oo-cpt>
<dom-module is="oo-cpt">
    <style></style>
    <template>    <style type="text/css">
            
            @ {
                font-family: 'Roboto','Helvetica','Arial',sans-serif!important;
            }
            .mdl-shadow--2dp {
                box-shadow: 0 2px 2px 0 rgba(0,0,0,.14),0 3px 1px -2px rgba(0,0,0,.2),0 1px 5px 0 rgba(0,0,0,.12);
            }
            .mdl-data-table {
                position: relative;
                border: 1px solid rgba(0,0,0,.12);
                border-collapse: collapse;
                white-space: nowrap;
                font-size: 13px;
                background-color: #fff;
            }
            
            .mdl-data-table tbody tr {
                position: relative;
                height: 48px;
                -webkit-transition-duration: .28s;
                transition-duration: .28s;
                -webkit-transition-timing-function: cubic-bezier(.4,0,.2,1);
                transition-timing-function: cubic-bezier(.4,0,.2,1);
                -webkit-transition-property: background-color;
                transition-property: background-color;
            }

            .mdl-data-table td {
                position: relative;
                vertical-align: top;
                height: 48px;
                border-top: 1px solid rgba(0,0,0,.12);
                border-bottom: 1px solid rgba(0,0,0,.12);
                padding: 12px 18px 0;
                box-sizing: border-box;
            }
            
            .mdl-data-table thead {
                padding-bottom: 3px;
            }
            
            .mdl-color-text--grey-600 {
                color: #757575 !important;
            }
              /* Define custom width and alignment of table columns */
              #treetable {
                table-layout: fixed;
              }
              #treetable tr td:nth-of-type(1) {
                text-align: right;
              }
              #treetable tr td:nth-of-type(2) {
                text-align: center;
              }
              #treetable tr td:nth-of-type(3) {
                min-width: 100px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
              }
            
            .grid {
                margin: 0 auto;
                max-width: 50em;
                padding: 0 1em;
                font-size: 1.5em;
            }
            
        </style>
        <iron-ajax
            auto
            url="try.xml"
            handle-as="text"
            last-response="{{xmlAjax}}"></iron-ajax>
            <div id="tree"></div>
        <div class="layout horizontal flex">
            <div>
                <iron-collapse id="pp" opened>
                    <div class="collapse-content">
                        <table id="treetable" class="table table-condensed table-hover table-striped">
                            <colgroup>
                                <col width="80px"></col>
                                <col width="10px"></col>
                                <col width="*"></col>
                                <col width="10px"></col>
                                <col width="10px"></col>
                                <col width="10px"></col>
                            </colgroup>
                            <thead>
                                <tr> <th></th> <th></th> <th>Classification</th> <th></th> <th></th> </tr>
                            </thead>
                            <tbody>
                                <tr> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr>
                            </tbody>
                        </table>
                    </div>
                </iron-collapse>
            </div>
        </div>

        <style>
            .collapse-content {
                padding: 15px;
                border: 1px solid #dedede;
            }
        </style>

        <table class="mdl-data-table mdl-js-data-table mdl-data-table--selectable mdl-shadow--2dp">
          <thead>
            <tr>
              <th class="mdl-data-table__cell--non-numeric">Material</th>
              <th>Quantity</th>
            </tr>
          </thead>
          <tbody>
             
          </tbody>
        </table>

        <tr>
            <data-source-elt-cpt elts="[[result]]"></data-source-elt-cpt>
            oo
        </tr>

        <div is="drop-area">drop here</div>


    </template>
    <script>
		Polymer({
            
            toggle: function() {
  this.$.pp.toggle();
  this.$.pp2.toggle();
            },
            
			is: 'oo-cpt',
            
            properties: {
                xmlAjax: {
                    type: String,
                    value: "",
                    observer: "handleResponse"
                },
                
                incKey: {
                    type: Number,
                    value: 1
                },
                
                result: {
                    
                }
                
            },
            
            handleResponse: function() {
                    var body = document.body,
                        dropArea = Polymer.dom(this.root).querySelector( '#drop-area' ),
                        droppableArr = [],
                        dropAreaTimeout;
                
                var that = this;
                console.log("/handleResponse")
                if(!this.xmlAjax) return;
                var result = xmlToJSON.parseString(this.xmlAjax);
                
                console.log(this.incKey, xmlToJSON.parseString(this.xmlAjax))
                var tree = Polymer.dom(this.root).querySelector('#treetable');
                var tree2 = Polymer.dom(this.root).querySelector('#treetable2');
                result = this.convertJSONtoFancyTree(result);
                this.result = result;
                console.log(this.result, result);
                glyph_opts = {
                    map: {
                        doc: "glyphicon glyphicon-file",
                        docOpen: "glyphicon glyphicon-file",
                        checkbox: "glyphicon glyphicon-unchecked",
                        checkboxSelected: "glyphicon glyphicon-check",
                        checkboxUnknown: "glyphicon glyphicon-share",
                        dragHelper: "glyphicon glyphicon-play",
                        dropMarker: "glyphicon glyphicon-arrow-right",
                        error: "glyphicon glyphicon-warning-sign",
                        expanderClosed: "glyphicon glyphicon-plus-sign",
                        expanderLazy: "glyphicon glyphicon-plus-sign",  // glyphicon-expand
                        expanderOpen: "glyphicon glyphicon-minus-sign",  // glyphicon-collapse-down
                        folder: "glyphicon glyphicon-folder-close",
                        folderOpen: "glyphicon glyphicon-folder-open",
                        loading: "glyphicon glyphicon-refresh"
                    }
                };
                
                $(function(){
                  // Create the tree inside the <div id="tree"> element.
                  $(tree).fancytree({
                      extensions: ["dnd", "edit", "glyph", "table"],
                      //checkbox: true,
                      dnd: {
                        focusOnClick: true,
                        /*dragStart: function(node, data) {
                            that.$.pp.hide();
                        },
                        dragEnter: function(node, data) { 
                        },
                        dragDrop: function(node, data) { 
                            console.log()
                            that.$.pp.show();
                            data.otherNode.copyTo(node, data.hitMode);
                        }*/
                      },
                      glyph: glyph_opts,
                      table: {
                        nodeColumnIdx: 2
                      },

                      activate: function(event, data) {
                      },
                      
                      renderColumns: function(event, data) {
                        var node = data.node,
                            $tdList = $(node.tr).find(">td");
                        $tdList.eq(0).text(node.getIndexHier());
                      },
                      source: result
                  });
                    
                });
                
                [].slice.call(Polymer.dom(this.root).querySelectorAll( '.fancytree-node' )).forEach( function( el ) {
                        new Draggable( el, droppableArr, {
                            draggabilly : { containment: document.body },
                            scroll : true,
                            scrollable : '#drop-area',
                            scrollSpeed : 20,
                            scrollSensitivity : 10,
                            onStart : function() {
                                console.log('start')
                            },
                            onEnd : function( wasDropped ) {
                            }
                        } );
                    } );
            },
            
            convertJSONtoFancyTree: function(nodes, isNotFolder) {
                var that = this,
                    convertedNodes = {},
                    finalNodes = [],
                    attr = [];
                
                convertedNodes = _.pairs(nodes);
                convertedNodes.forEach(function(node) {
                    attr = [];
                    node[1].title = node[0];
                    node[1].key = that.incKey;
                    node[1].folder = !isNotFolder;
                    if(node[1][0]) {
                        if (_.has(node[1][0], '_text'))
                            node[1].folder = false; 
                        else {
                            attr = that.convertJSONtoFancyTree( node[1][0]._attr, true );
                            node[1][0] = _.omit(node[1][0], '_attr');
                            node[1].children = _.union(attr, that.convertJSONtoFancyTree(node[1][0]));
                        }
                    }
                    node[1] = _.omit(node[1], '0');
                    that.incKey = that.incKey + 1;
                    finalNodes.push(node[1]);
                });
                
                //finalNodes[0] = _.omit(finalNodes[0], 'children');
                return finalNodes;
            }
            
        });
    </script>
</dom-module>